# Managing Memory for a Virtual Machine

The virtual machine. Unlike the CPU, memory is usually the resource that is consumed the fastest. Hypervisors abstract memory by handling data blocks between the server’s physical memory and what has been allocated to the virtual machines. The management of memory resources by both the hypervisor and the administrator is important for effective use of the physical resources.

- Understanding memory virtualization
- Configuring VM memory options
- Tuning practices for VM memory

### Understanding Memory Virtualization

Thirty years ago, the concept of computer memory was isolated in a few pockets of people who, in some way or another, were involved with computer technology. They didn’t even refer to it as memory but rather as RAM, which stands for random access memory. RAM was thought of and treated as another storage device, like a disk, but it was much faster, and you could access data in memory with a more flexible model than accessing data from disk storage devices. System memory sizes were much smaller as well, measured in kilobytes and then megabytes. 

Let’s contrast that with today’s environment. Personal computers and smartphones routinely are offered with gigabytes of memory. The latest iPads can come configured with up to 16 GB of RAM along with 1 TB of storage. Other tablets are similarly provisioned as well. In addition to those items, many other devices that are part of our daily experience have memory as part of their configurations. Digital cameras, streaming devices, and game systems have all added to our pool of common consumer electronics. Currently, we are on the cusp of a wave of all-new consumer devices enabled for the Internet of Things offering us web-enabled automobiles, refrigerators, and even lightbulbs. Each of these will require storage to keep information and memory to have a workspace to operate on that data. 

With the spread of these commercial devices, the understanding of what memory provides to computing has also spread throughout the population so that today both 12-year-old children and 70-year-old grandparents are aware of, and often knowledgeable about, memory.

Memory is a computer’s workspace. When an operating system boots up, certain regularly used routines are loaded into memory and stay there. As programs are executed, those routines are also copied into memory for speed of execution and quick access for reuse. When programs work on information, that data is also moved into memory so all of the calculation’s various parts and pieces can be quickly transferred to the CPU for processing and then written back to memory after whatever transformations the CPU has performed. With more memory, computers can access and process larger amounts of data faster. 

In game systems, streaming devices, and digital video recorders (DVRs), memory is used as a buffer to stage data so it can be smoothly presented to a screen. With the growing spread of real-time multimedia streaming in the consumer marketplace, memory is a critical part of the equation.

The same holds true for virtualization. More than any other resource, memory is the one with the largest impact on how well or how poorly the virtual environment will perform. As with CPU virtualization, the hypervisor abstracts memory by using the physical server’s memory on behalf of the virtual machines it supports. To understand how memory works in a virtual environment, we need to return to the Windows virtual machine that was created in Chapter 5, “Installing Windows on a Virtual Machine.” We began with 4GB of memory, and, as shown in Figure 8.1, we later looked at adjusting that to 4.5GB. The physical system on which the virtual machine is hosted has more than that, whether it is the 8GB that the test system is using or the hundreds of gigabytes with which current servers are outfitted. The point is that the virtual machine, and by extension, the operating system in the virtual machine, is only aware of the 4 GB that is allocated.


But that 4 GB may not be nearly enough working area to hold an operating system, some applications (for example, Microsoft Word, Adobe Acrobat Reader, and Mozilla Firefox), and the data you might be using with those applications. Because of this, operating systems have been developed to constantly shuttle program and data information between physical memory and disk storage. Memory blocks are referred to as pages, and they are usually moved around in uniform sizes; in today’s architecture, a typical memory page size is 4 KB. This 4KB page size is based on the processor type and architecture, but it can be adjusted. There are applications that benefit from having larger blocks of data shuttled in and out of memory, but there is usually little need to configure larger pages.

When memory blocks need to be freed up so newer information can be loaded, the older, less recently used blocks are written to disk. The disk acts as an extension of the physical memory, and the process of copying the pages to the disk is called paging. The file that the memory pages are copied to is usually called the page file. Processors have physical memory, called cache, as part of their makeup, where work is queued up before entering the CPU. 


Because working with disk storage is much slower than working with memory, from a performance standpoint, paging is an expensive process. Even today, as physical storage is transforming from the spinning disks that have been prevalent for the last 50 years to solid-state drives without moving parts, having data already in memory is orders of magnitude faster than retrieving it from any type of physical drive.

### Configuring VM Memory Options

For such an important part of the virtual machine, it is a bit ironic that there is only one adjustment that can be made to a virtual machine’s memory, and that is to either increase or decrease the size. Additional elements are built into the hypervisor that can be changed on a macro level to adjust memory usage throughout the host, but we’ll cover them in the next section. Just as with a physical server, a virtual server must be configured with enough resources to do the job it has been assigned. If too much memory is assigned, then memory could be wasted, not being available to other virtual machines. If too little memory has been configured, then memory will constantly be paging to the physical disk and affect the performance of the applications. The trick is to find the sweet spot between too much and too little. Fortunately, best practices and performance tools are available to help guide the way.

1. Although we went through this exercise when you created your virtual machine, let’s take another look at setting the memory in a virtual machine. In VMware Player, select the Windows 11 virtual machine.
2. At the bottom right or from the Virtual Machine menu, select **Edit Virtual Machine Settings**.
3. The first hardware device highlighted is **Memory**. As shown in Figure 8.3, you can see the memory configuration for the Windows 11 virtual machine. You can adjust the memory up or down by using the slider or by directly changing the value in the **Memory For This Virtual Machine** text box.


4. VMware Player provides three default values: a minimum recommended memory value, a recommended memory value, and a maximum recommended memory value. The minimum and recommended values are based on the guest operating system, while the maximum amount is based on the amount of memory in the host server.
5. Click **Cancel** to close the Virtual Machine Settings window.

Memory adjustments are dependent on the operating system installed in the virtual machine. Dynamic additions of memory without a reboot are possible in operating systems that support this capability. Microsoft Windows, since Windows Server 2003, and current distributions of Linux support hot-add memory. 

Windows versions will recognize the additional memory without intervention. Some Linux versions need to have a command executed to set the memory status to online before it will be available to the system, physical or virtual. Although you can also edit a virtual machine to remove memory, current operating system releases require a system reboot to make the adjustment. Microsoft Hyper-V does allow hot-remove of memory under certain conditions since Windows Server 2016. Depending on the Type 2 hypervisor being used, you might still need to reboot the virtual machine for hot-add or hot-remove changes to be applied, even if the guest operating system supports hot-add or hot-remove capabilities.

# Tuning Practices for VM Memory

Context is important when you’re working with memory in a virtual environment. So far, we have looked at memory only from the standpoint of the virtual machine looking outward. The amount of memory that has been allocated to the virtual machine is what it can use. The physical host it resides on may have hundreds of gigabytes available, but each individual virtual machine is unaware of the greater resources. Figure 8.4 shows a simple illustration of this model.

The two virtual machines have been allocated 4GB and 2 GB of memory, respectively, and that is all the memory that the guest operating systems in those virtual machines are aware of. The physical host actually has 16GB of physical memory. With 6GB of memory already spoken for by the two virtual machines, there are still 10 GB of memory available on the host for use—but that isn’t entirely accurate.

## Calculating Memory Overhead

The hypervisor itself needs to reserve some portion of the memory for its own processes, much as an operating system reserves memory. In the past, this would be a significant portion of physical memory, upward of 20 percent in some cases, but newer hypervisor technology has drastically reduced that amount. For each virtual machine running on the host, a small portion of memory is also reserved, in addition to the memory allocated for the use of the virtual machine. This additional memory is used for operational functions such as memory mapping tables—connecting the virtual machine memory addresses to the physical memory addresses. The actual overhead numbers vary by hypervisor implementation and the memory configurations of the individual virtual machines. For this discussion, we can use the round number of 1GB of memory to cover both the hypervisor overhead and the virtual machine overhead and be comfortable that we’ve allocated enough memory whatever parameters we change. That would reduce the available memory to 9 GB.

Now let’s add a few more virtual machines. Two additional 4 GB virtual machines and one 1GB virtual machine will consume the remainder of the available physical memory. In practice, most systems are never fully utilized in this way for a number of reasons, the primary one being that administrators always keep resources in reserve for a rainy day. As virtual machines grow, or unanticipated performance demands appear, having a reserve pool of memory, or any resource, to supplement from makes good business sense. This model now has five guests that are utilizing 15 GB of physical memory, but that is not very efficient.

From a strict virtualization standpoint, we haven’t improved the utilization of the shared resource, memory, since we aren’t sharing it. Each virtual machine is, from a memory standpoint, still behaving like a physical server with a defined amount of dedicated memory. If you compare CPU virtualization and memory virtualization, they are very similar. Both resources depend on the hypervisor to manage the allocation of the larger physical device, while providing the appearance of servicing the virtual device.

The hypervisor determines which pages are written into physical memory, and it keeps track of how each virtual machine’s allocated memory is mapped to the physical server’s memory through the previously mentioned tables. This holistic view of memory in both the physical and virtual environments puts the hypervisor in a unique position to provide some interesting capabilities. Instead of having a fixed amount of memory, what if you could vary memory up and down depending on the workload? As part of that process, you would need a way to reclaim memory pages that were no longer needed. Storage technologies today routinely use deduplication and compression technologies for improved performance and cost savings. Could you do this with memory as well? The answer to both of those questions is yes.

## Memory Optimizations

The five virtual machines are allocated 15 GB of memory among them, but in reality they are probably using much less. Application owners routinely ask for more memory than normally required to handle growth and performance spikes. Physical servers, because of the static nature of their configuration, are sized with additional memory for future capacity and potential need. These ingrained practices often find their way into the virtual world as well. The result is that virtual machines often are unnecessarily allocated more memory than they need. The hypervisor has the ability to circumvent that issue. Because the hypervisor controls all of the physical memory operations and the virtual machine’s view of those operations, it is simple to tell the virtual machine that it has a certain amount of memory but then work behind the scenes to make that amount flexible.

Even though a virtual machine is allocated an amount of memory, say 2 GB, the memory is not hard reserved for the VM. The hypervisor can use any of that memory for other virtual machines. The memory allocation is like a high-water mark, and the hypervisor raises and lowers the actual memory amount that is being used. From the guest operating system standpoint, the virtual machine has 2 GB and behaves accordingly. One technique that is used to reclaim memory from the virtual machine is called ballooning. A simple illustration of ballooning memory is shown in Figure 8.5. To take the physical memory back from a virtual machine, the pages that are in memory need to be flushed back to a different storage device; in this case, the paging area of the disk. The balloon driver is activated and (virtually) inflates, forcing the operating system to flush pages from memory. The operating system chooses the pages to flush because it knows which pages are the least recently used and are stale, making them good candidates to remove. Once the pages are flushed, the balloon driver deflates, and the hypervisor reclaims the physical memory for use. Usually, this process happens only when there is contention for memory.

**Ballooning memory** is a memory management technique used in virtualized environments to efficiently reclaim memory from virtual machines (VMs) when the host system is under memory pressure. It helps optimize memory utilization without needing to shut down or pause the VMs. Here’s how it works:

### How Ballooning Works:
1. **Balloon Driver**: Each virtual machine has a balloon driver installed in its guest operating system. This driver controls the amount of memory that can be "inflated" or "deflated" inside the VM.
   
2. **Inflation**: When the hypervisor detects that the host is running low on memory, it activates the balloon driver. The driver "inflates" the balloon, which forces the guest operating system to free up memory by swapping out or releasing pages of memory that are no longer in use.

3. **Deflation**: Once memory is reclaimed from the guest OS and released back to the hypervisor, the balloon driver "deflates," making the memory available for other VMs or processes on the host.

### Purpose of Ballooning:
- **Memory Reclamation**: It helps the hypervisor reclaim memory from VMs that are not using all of their allocated memory, allowing it to be redistributed to other VMs that need more memory.
- **Resource Management**: Ballooning enables efficient memory overcommitment, where more virtual memory is allocated to VMs than physically exists on the host, by dynamically adjusting the memory usage based on the demand.

### Key Points:
- Ballooning is a dynamic process and only happens when the host is experiencing memory contention.
- It avoids shutting down VMs or swapping to disk, making it a more efficient method of managing memory.
- It requires that the guest operating systems have the balloon driver installed and properly configured.

In short, ballooning memory allows the hypervisor to manage memory allocation more flexibly, reducing waste and improving the overall memory utilization on the host system.

### Memory Overcommitment

Memory overcommitment is a powerful virtualization technique, but it is important to understand the memory usage characteristics of your virtual machines for it to be effective. Idle virtual machines, or VMs with more memory allocated than they use, allow the hypervisor to manage the memory resource across more virtual machines for a better consolidation ratio, as you saw in the example. The example with the virtual machines using half of their memory is considered to be a 2-to-1 overcommitment ratio. Many mature virtual environments use memory overcommitment, and those that do run somewhere between a 1.5-to-1 and that 2-to-1 ratio. Application environments that are well understood can run at significantly higher ratios, 10-to-1 or even 20-to-1, although these are definitely the far edge exceptions to the rule.

In addition to overcommitment, there are other methods to help increase effective memory utilization in a virtual environment. One of these is page sharing. Page sharing is analogous to data deduplication, which is a technique that storage vendors use to reduce data blocks and save disk space by storing only one copy of a duplicated data block. With 10 virtual machines, it would not be unusual for many of them to be running the same version of their guest operating system, or even the same applications. Large Internet providers often run dozens if not hundreds or thousands of application web servers, each of which is identically configured from the hardware to the operating system and to the application programs. When the virtual machine loads operating system pages or application program pages into memory, many of these pages are identical from one virtual machine to another. Because the hypervisor manages all of the page transfers between virtual machines and the physical memory, it can determine which pages are already in physical memory and use that page instead of writing yet another copy to physical memory. Figure 8.7 illustrates this sharing process. Some memory pages contain operating system or application program code that will never be altered by a user or system process. Other memory pages contain application- or user-specific data that can be dynamically updated. If a virtual machine needs to write to a memory page that has already been designated as a shared page, the hypervisor will create a new copy of that page for that virtual machine’s exclusive use. This process is called copy-on-write.

### Page Sharing

Not only does page sharing work between different virtual machines, but it works within the same virtual machine as well. Without having to duplicate these shared pages, even more memory is reclaimed by the hypervisor for use by the virtual machines. In practice, page sharing can save an additional 10 to more than 40 percent of the available physical memory. Virtualization allowed the Internet providers mentioned earlier to consolidate those hundreds of application web servers into not only a much smaller and less costly physical environment but, through the use of memory overcommitment and page sharing, a much more efficient one. Another utilization that benefits from page sharing is Virtual Desktop Infrastructure (VDI). VDI is the virtualization of a company’s desktop computers, as opposed to the server virtualization on which we’ve focused. With desktop operating systems largely standardized on Windows, for example, multiple desktop virtual machines can share operating system files, saving significant memory resources.

Another technique that can be used to reduce the memory footprint is compression. This process works similarly to data compression for storage. When memory pages are moved to storage or over to another host, they can be compressed, allowing more data to be stored in the same amount of space. If the hypervisor is capable of compressing the memory pages before writing them, the virtual machine’s memory will be used more efficiently, even if the physical memory is not fully utilized. Memory compression can significantly reduce the likelihood of memory paging, which occurs when the hypervisor swaps pages out of physical memory into storage.

## Final Thoughts on Virtual Machine Memory

Understanding memory operations in virtual environments and applying the various techniques to manage memory use is one of the most important tasks for maximizing the efficiency of virtualized resources. It is also one of the areas where you can often find the most savings. Memory overcommitment, ballooning, page sharing, and compression allow the virtual environment to use the physical memory on a host much more efficiently than is possible with physical hardware. Even if the physical memory appears to be completely allocated, much of it is shared, compressed, or used only when required, giving you the ability to overcommit and run more virtual machines with fewer physical resources.
